# ublox XPLR-AOA-2 explorer kitså®šä½å¥—ä»¶ä½¿ç”¨æŒ‡å—

ä½œè€…ï¼šæ±¤ç«‘æ•¬

è”ç³»æ–¹å¼ï¼š12011827@mail.sustech.edu.cn / å¾®ä¿¡:13769875999

èµ„æ–™é™„ä»¶ï¼šhttps://github.com/555hhh555hhh/Bluetooth-AOA

äº§å“å®˜ç½‘ï¼šhttps://www.u-blox.com/en/product/xplr-aoa-2-kit

## è®¾å¤‡é…ç½®

> [!NOTE]
>
> åœ¨å¼€å§‹ä½¿ç”¨ä¹‹å‰ï¼Œå»ºè®®åœ¨[å®˜ç½‘](https://www.u-blox.com/en/product/xplr-aoa-2-kit?legacy=Current#Product-description)ä¸‹è½½æœ€æ–°çš„ç”¨æˆ·æ‰‹å†Œå’ŒDataSheeté˜…è¯»ï¼Œæœ¬æ–‡ä»…ä¾›å‚è€ƒ

### C211 anchor å¤©çº¿æ¥æ”¶æ¿å›ºä»¶åˆ·æ–°

1. ä¸‹è½½å¹¶å®‰è£…ubloxå®˜æ–¹[ä¸Šä½æœºç¨‹åº](https://www.u-blox.com/en/product/s-center)

2. æ‰“å¼€ä¸Šä½æœºs-centerï¼Œé€‰æ‹©ä¸²å£å·è¿æ¥ï¼Œæ£€æŸ¥æ³¢ç‰¹ç‡ã€å¥‡å¶æ ¡éªŒã€æ•°æ®ä½ã€åœæ­¢ä½ç­‰å‚æ•°

   <img src="Image\image-20240517223735546.png" alt="image-20240517223735546" style="zoom:80%;" />

   <img src="Image\image-20240517223213278.png" alt="image-20240517223213278" style="zoom:75%;" />

   ä¸Šç”µä¹‹åPOWERæŒ‡ç¤ºç¯å¸¸äº®ï¼Œä¸Šä½æœºè¿æ¥æˆåŠŸè¿æ¥åCTSæŒ‡ç¤ºç¯å¸¸äº®

3. åˆ‡æ¢å¤©çº¿æ¿è¿›å…¥åˆ°ç¨‹åºä¸‹è½½æ¨¡å¼

   > [!IMPORTANT]
   >
   > Hold down SW2 during board reset to enter the download mode. 

â€‹	æŒ‰ä½SW2ï¼Œæ’æ‹”æ•°æ®çº¿æ¥ä½¿ç”µè·¯æ¿é‡æ–°ä¸Šç”µï¼Œè¿™æ—¶å€™å°±èƒ½è¿›å…¥ä¸‹è½½æ¨¡å¼ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°ç”µè·¯æ¿ä¸ŠDSRå’ŒCTSé«˜é€Ÿé—ªçƒï¼ˆä¸€æ®µæ—¶é—´åä¼šç†„ç­ï¼Œä½†å‡ºç°é—ªçƒå·²ç»æ ‡å¿—è¿›å…¥äº†ä¸‹è½½æ¨¡å¼ï¼‰ã€‚

4. çƒ§å½•ç¨‹åº

   ç‚¹å‡»Software UpdateæŒ‰é’®ï¼Œé€‰æ‹©åˆé€‚çš„æ–‡ä»¶è¿›è¡Œçƒ§å½•ï¼Œæ ¼å¼ä¾‹å¦‚NINA-B4-nRFC-DF-SW-2.1.0-005.binï¼Œè¿˜è¦æ³¨æ„è°ƒæ•´æ³¢ç‰¹ç‡ã€‚

   å¯èƒ½ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´æ‰å‡ºç°å¦‚ä¸‹æ‰€ç¤ºé»‘æ¡†ï¼Œæˆ–è€…å‡ºç°é»‘æ¡†åè¦ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰å¼€å§‹æœ‰è¿›åº¦æ¡å˜åŠ¨

<img src="Image\image-20240517224331320.png" alt="image-20240517224331320" style="zoom:50%;" />

5. çƒ§å½•å®Œæˆ

<img src="Image\image-20240517231107248.png" alt="image-20240517231107248" style="zoom:80%;" />

â€‹	è¿™æ—¶ç”µè·¯æ¿DS1å¸¸äº®ç»¿ç¯ï¼ŒCTSå’ŒRTSæŒ‡ç¤ºç¯å¸¸äº®ï¼Œä»£è¡¨å·¥ä½œæ­£å¸¸ã€‚ä¸Šä½æœºä¹Ÿä»ä¸²å£è¯»åˆ°æ•°æ®ï¼Œä»£è¡¨å·¥ä½œæ­£å¸¸ã€‚

> [!NOTE]
>
> ä½¿ç”¨ATå‘½ä»¤äº¤äº’æ¡†å¯ä»¥å’Œæ›´æ”¹ç”µè·¯æ¿è®¾ç½®ï¼Œå…·ä½“æŸ¥çœ‹ATå‘½ä»¤æ‰‹å†Œï¼Œè¾“å…¥å†…å®¹åæŒ‰é”®ç›˜å›è½¦ENTERé”®å‘é€

### C209 Tag è“ç‰™æ ‡ç­¾å›ºä»¶åˆ·æ–°

æˆ‘é˜…è¯»ç”¨æˆ·æ‰‹å†Œçš„ç†è§£æ˜¯c209ä¸å¯ä»¥ä½¿ç”¨s-centeræ¥åˆ·å›ºä»¶ï¼Œä½†æ˜¯æ‰‹å†Œé‡Œä»ç„¶ç»™äº†å®ä¾‹ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰æµ‹è¯•æˆåŠŸï¼Œæ‰€ä»¥è¿˜æ˜¯ä½¿ç”¨æ¯”è¾ƒåŸå§‹çš„æ–¹æ¡ˆæ¥è¿›è¡Œçƒ§å½•ï¼ŒåŒ4.4.2.1å’Œ4.4.2.3èŠ‚çš„å†…å®¹ã€‚

1. ä¸‹è½½çƒ§å½•è½¯ä»¶nrfutil

   ä»åŸä½œè€…[githubé“¾æ¥](https://github.com/NordicSemiconductor/pc-nrfutil/releases)å¤„ä¸‹è½½æˆ–è€…ä»[ä¾¿æ·ä»“åº“](https://github.com/555hhh555hhh/Bluetooth-AOA/tree/main/nrfutil)ä¸‹è½½

2. ä¸‹è½½å›ºä»¶åŒ…

   ä»åŸä½œè€…[githubé“¾æ¥](https://github.com/u-blox/c209-aoa-tag/releases)å¤„ä¸‹è½½æˆ–è€…ä»[ä¾¿æ·ä»“åº“](https://github.com/555hhh555hhh/Bluetooth-AOA/tree/main/C209%E5%9B%BA%E4%BB%B6)ä¸‹è½½

3. è®©C209è¿›å…¥ä¸‹è½½æ¨¡å¼

   > [!IMPORTANT]
   >
   >  press and hold the SW2 button on the C209 tag while resetting the board (either by inserting the USB cable or pressing the RESET button) to set the bootloader in â€œdownloadâ€ mode. 

   æŒ‰ä½SW2æŒ‰é”®ï¼ˆé è¿‘LEDé‚£ä¸ªï¼‰æ’æ‹”æ•°æ®çº¿é‡æ–°ä¸Šç”µæ¥è¿›å…¥ä¸‹è½½æ¨¡å¼ï¼Œæ˜¯å¦æˆåŠŸè¿›å…¥ä¸‹è½½æ¨¡å¼ä¼¼ä¹æ²¡æœ‰æ˜æ˜¾æç¤º

4. è¿›è¡Œçƒ§å½•

   ä¹‹å‰ä¸‹è½½äº†nrfutilè½¯ä»¶ï¼ŒåŒå‡»è¿è¡Œåº”è¯¥ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿï¼Œè¿™ä¸ªè½¯ä»¶ç±»ä¼¼äºå®‰è£…pythonï¼Œéœ€è¦åœ¨æ§åˆ¶å‘½ä»¤è¡Œcmdæ¥ä½¿ç”¨å®ƒã€‚

<img src="Image\image-20240517235223443.png" alt="image-20240517235223443" style="zoom:80%;" />

â€‹	ä½†ç°åœ¨è¿˜ä¸èƒ½ç›´æ¥è¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯æŠŠè¿™ä¸ªè½¯ä»¶ä¸‹è½½ä¸‹æ¥ï¼Œç³»ç»Ÿè¿˜ä¸çŸ¥é“æˆ‘ä»¬ä¸‹è½½äº†è¿™ä¸ªè½¯ä»¶ï¼Œæ‰€ä»¥è¦æŠŠå®ƒæ·»åŠ åˆ°ç³»ç»Ÿè·¯å¾„

åœ¨Windowsæœç´¢æ¡†æœç´¢â€œé«˜çº§ç³»ç»Ÿè®¾ç½®â€å¹¶æ‰“å¼€

<img src="Image\image-20240517235715384.png" alt="image-20240517235715384" style="zoom:50%;" />

ç‚¹å‡»ç¯å¢ƒå˜é‡->ç³»ç»Ÿå˜é‡->Path->ç¼–è¾‘

<img src="Image\image-20240518000103118.png" alt="image-20240518000103118" style="zoom:67%;" />

æ–°å»º->æµè§ˆ->é€‰æ‹©åŒ…å«nrfutilç¨‹åºçš„æ–‡ä»¶å¤¹ç‚¹ç¡®å®š

<img src="Image\image-20240518000522961.png" alt="image-20240518000522961" style="zoom:67%;" />

ç°åœ¨èƒ½ä½¿ç”¨nrfutiläº†ï¼Œä½†æ˜¯ä¸ºäº†è¾“å…¥å‘½ä»¤ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŒ…å«çƒ§å½•æ–‡ä»¶çš„æ–‡ä»¶å¤¹é‡Œæ‰“å¼€æ§åˆ¶å‘½ä»¤è¡Œï¼Œå°±ä¸ç”¨è¾“å…¥æ–‡ä»¶ä½ç½®äº†ã€‚

é¦–å…ˆæ‰¾åˆ°é€‚åˆçƒ§å½•çš„æ–‡ä»¶

<img src="Image\image-20240518001338051.png" alt="image-20240518001338051" style="zoom:80%;" />

<img src="Image\image-20240518001545271.png" alt="image-20240518001545271" style="zoom:80%;" />

è¿™æ—¶å€™æ§åˆ¶å‘½ä»¤è¡Œå°±èƒ½å¤Ÿç›´æ¥ä½¿ç”¨äº†ï¼Œè¾“å…¥å‘½ä»¤å¹¶è¿è¡Œï¼Œ**æ³¨æ„ä¿®æ”¹ä¸²å£å·**

`nrfutil dfu serial -pkg NINA-B4-DF-TAG-SW-2.0.1-001.zip -p COM17 -b 115200 -fc 1`

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¬¬ä¸€æ¬¡è¿è¡Œå‘½ä»¤æ˜¯æ­£å¸¸çƒ§å½•ï¼Œç¬¬äºŒæ¬¡è¿è¡Œæ—¶æ²¡æœ‰è¿›å…¥ä¸‹è½½æ¨¡å¼å¯¼è‡´çš„é”™è¯¯

> [!IMPORTANT]
>
> è¿è¡Œå‘½ä»¤åè¯·è€å¿ƒç­‰å¾…è‡³å°‘1åˆ†é’Ÿï¼Œåæ­£æŠ¥é”™ä¼šè‡ªå·±åœæ­¢ï¼Œä¸è¦æ‰‹åŠ¨å»ç»ˆæ­¢ã€‚ä¸€èˆ¬æ¥è¯´è¦ç­‰å¾…ä¸€æ®µæ—¶é—´åè¿›åº¦æ¡æ‰ä¼šå¼€å§‹å˜åŒ–ã€‚

<img src="Image\image-20240518001715027.png" alt="image-20240518001715027" style="zoom:80%;" />

5. æ£€æŸ¥æ˜¯å¦çƒ§å½•æˆåŠŸ

   å¯ä»¥æœ‰å¤šç§æ–¹å¼æ£€æŸ¥æ˜¯å¦çƒ§å½•æˆåŠŸ

   æŒ‡ç¤ºç¯æ³•ï¼šæŒ‡ç¤ºç¯å‘¨æœŸæ€§é—ªçƒ

   æŒ‰é”®æ³•ï¼šæŒ‰SW2æŒ‰é”®ï¼Œè§‚å¯Ÿæ˜¯å¦æœ‰ç¯é—ªçƒ

   ä¸²å£é€šä¿¡æ³•ï¼šæ‰“å¼€s-centerï¼Œæµæ§åˆ¶é€‰æ‹©nanoï¼Œé€‰æ‹©ä¸²å£è¿›è¡Œè¿æ¥ã€‚

   â€‹	å¯ä»¥è¿›è¡Œç®€å•çš„é€šä¿¡æµ‹è¯•ï¼Œè¯·æ³¨æ„ï¼ŒC209çš„ä¸²å£åªåœ¨å¼€æœºå10så†…å¯ç”¨ï¼Œå¦‚æ— åº”ç­”å¯ä»¥æŒ‰RESETæŒ‰é’®å†å°è¯•ã€‚

   â€‹	<img src="Image\image-20240518003102466.png" alt="image-20240518003102466" style="zoom:67%;" />

## æ•°æ®è¯»å–

å›ºä»¶åˆ·æ–°åå°±å¯ä»¥å¼€å§‹è¿›è¡Œå®šä½å®éªŒï¼Œå¯ä»¥ä½¿ç”¨ä¸Šä½æœºè¿›è¡Œæ•°æ®è¯»å–æˆ–è€…ä½¿ç”¨Pythonæˆ–è€…å…¶ä»–ç¼–ç¨‹è¯­è¨€è¯»å–ä¸²å£æ•°æ®ï¼Œè¿›è¡Œå¸§è§£ç è§£ææ•°æ®ã€‚

### ä¸Šä½æœºå®šä½

å°†C211å¤©çº¿æ¿è¿æ¥åˆ°ç”µè„‘ï¼Œæ‰“å¼€s-center

<img src="Image\image-20240518003852404.png" alt="image-20240518003852404" style="zoom:67%;" />

æŠ¥æ–‡ä¸ªå­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š

|               æ•°æ®æŠ¥æ–‡å­—æ®µå«ä¹‰               |      å€¼      |
| :------------------------------------------: | :----------: |
|            Eddystone instance ID             | CCF9578E0D8A |
|           RSSI of 1st polarization           |     -42      |
|                   Angle 1                    |     -10      |
|                   Angle 2                    |      2       |
|                   Reserved                   |     -43      |
|               Detected channel               |      39      |
|      Anchor ID as set by AT+UDFCFG tag       | CCF9578E0D89 |
| User defined strings as set by AT+UDFCFG tag |      -       |
|                  Timestamp                   |    15921     |
|     Periodic advertising sequence number     |      25      |

å³ç¬¬ä¸‰å­—æ®µä»£è¡¨æ°´å¹³è§’åº¦ï¼Œç¬¬å››å­—æ®µä»£è¡¨å‚ç›´è§’åº¦

### [Python](https://github.com/555hhh555hhh/Bluetooth-AOA/blob/main/codes/serialTest.py)æ•°æ®è¯»å–

ä½¿ç”¨Pythonè¿›è¡Œæ•°æ®è¯»å–ï¼Œåœ¨è®¾ç½®ä¸²å£æ—¶éœ€è¦å¢åŠ ä¸€äº›è®¾ç½®ï¼Œç‰¹åˆ«æ˜¯å¼€å¯RTSCTS

<img src="Image\image-20240518005605295.png" alt="image-20240518005605295" style="zoom:80%;" />

åœ¨æ­»å¾ªç¯ä¸­è¯»å–ä¸²å£æ•°æ®

<img src="Image\image-20240518005655206.png" alt="image-20240518005655206" style="zoom:80%;" />

![image-20240518005740131](Image\image-20240518005740131.png)

è¿›è¡Œæ•°æ®ç­›é€‰ï¼Œåªä¿ç•™ä¸¤ä¸ªè§’åº¦çš„ä¿¡æ¯

<img src="Image\image-20240518005831578.png" alt="image-20240518005831578" style="zoom:80%;" />

![image-20240518005857061](Image\image-20240518005857061.png)

```python
import serial

# é…ç½®ä¸²å£å‚æ•°
ser1 = serial.Serial(
    port='COM13',
    baudrate=115200,
    stopbits=serial.STOPBITS_ONE,
    bytesize=serial.EIGHTBITS,
    parity=serial.PARITY_NONE,
    rtscts=True
)

try:
    while True:
        # è¯»å–ä¸²å£æ•°æ®
        data1 = ser1.readline().decode('utf-8').strip()
        # print(data1)
        
        # è§£æå¹¶ç­›é€‰æ•°æ®
        if data1.startswith("+UUDF:"):
            parts1 = data1.split(',')
            if len(parts1) == 10:
                # æå–ç¬¬ä¸‰ã€ç¬¬å››æ•°æ®æ®µ
                angle1 = [int(parts1[2]),int(parts1[3])]

                # æ‰“å°æ•°æ®
                print(angle1[0],angle1[1])

except serial.SerialException as e:
    print("æ‰“å¼€ä¸²å£å¤±è´¥ï¼š", e)

finally:
    # å…³é—­ä¸²å£
    ser1.close()
    print("ä¸²å£å·²å…³é—­")
```



## ä¸‰è§’å®šä½ç®—æ³•

### ç†è®ºè®¡ç®—



<img src="Image\image-20240518010741124.png" alt="image-20240518010741124" style="zoom:50%;" />

å‡è®¾åœ¨äºŒç»´ç©ºé—´ä¸­ï¼Œæœ‰ä¸¤ä¸ªåŸºç«™åˆ†åˆ«ä½äºA\(x1, y1\)ã€B\(x2, y2\)ï¼Œè€Œå¾…å®šä½çš„ç§»åŠ¨åŸºç«™N(x, y)ã€‚å¦‚æœåŸºç«™Aå’ŒBæµ‹é‡åˆ°çš„ä¿¡å·åˆ°è¾¾è§’åº¦åˆ†åˆ«ä¸ºÎ¸1ã€Î¸2

ç”±ç›´çº¿æ–œç‡å…³ç³»å¯å¾—å¦‚ä¸‹æ–¹ç¨‹ï¼š![image-20240518011150793](Image\image-20240518011150793.png)

å°†ä¸Šå¼å˜å½¢ï¼Œæ„é€ çº¿æ€§æ–¹ç¨‹ç»„å¾—ï¼š![image-20240518011205581](Image\image-20240518011205581.png)

æ±‚è§£æ–¹ç¨‹ç»„ï¼Œå³å¯å¾—å‡ºç§»åŠ¨åŸºç«™ğ‘çš„ä½ç½®åæ ‡ï¼š![image-20240518011226178](Image\image-20240518011226178.png)

### [Python](https://github.com/555hhh555hhh/Bluetooth-AOA/blob/main/codes/Triangulation.py)å®ç°

æ³¨æ„é¦–å…ˆè¦åˆå§‹åŒ–åŸºç«™ä½ç½®ï¼Œä¸”è¦æ³¨æ„åˆ›å»ºçš„ä¸¤ä¸ªä¸²å£ser1ã€ser2å’Œstation1ã€station2çš„å¯¹åº”å…³ç³»

```python
import math
import serial
import matplotlib.pyplot as plt

# åˆ›å»ºä¸²å£å¯¹è±¡
ser1 = serial.Serial(
    port='COM7',
    baudrate=115200,
    stopbits=serial.STOPBITS_ONE,
    bytesize=serial.EIGHTBITS,
    parity=serial.PARITY_NONE,
    rtscts=True
)

ser2 = serial.Serial(
    port='COM4',
    baudrate=115200,
    stopbits=serial.STOPBITS_ONE,
    bytesize=serial.EIGHTBITS,
    parity=serial.PARITY_NONE,
    rtscts=True
)

# åŸºç«™ä½ç½®
station1 = (100, 0)
station2 = (300, 0)

# åˆå§‹åŒ–å›¾å½¢
plt.figure()
plt.axis([0, 400, 0, 400])  # è°ƒæ•´æ¨ªçºµåæ ‡èŒƒå›´
plt.plot(station1[0], station1[1], 'ro', label='Station 1')
plt.plot(station2[0], station2[1], 'bo', label='Station 2')
plt.legend()

# å­˜å‚¨äº¤ç‚¹çš„åæ ‡
intersections = []
angles = []

def update_position(angle1, angle2):
    global intersections  # ä½¿ç”¨å…¨å±€å˜é‡
    # è®¡ç®—ç›®æ ‡ç‚¹ä½ç½®
    # æ ¹æ®è§’åº¦å’ŒåŸºç«™ä½ç½®è®¡ç®—ç›®æ ‡ç‚¹åæ ‡
    theta1 = (90 - angle1) * math.pi / 180
    theta2 = (90 - angle2) * math.pi / 180

    # è®¡ç®—äº¤ç‚¹åæ ‡
    x1, y1 = station1
    x2, y2 = station2
    
    # è®¡ç®—ä¸‰è§’å‡½æ•°
    tan_theta1 = math.tan(theta1)
    tan_theta2 = math.tan(theta2)
    cot_theta1 = 1 / math.tan(theta1)
    cot_theta2 = 1 / math.tan(theta2)
    
    # è®¡ç®—äº¤ç‚¹çš„åæ ‡
    x = ((y2 - x2 * tan_theta2) - (y1 - x1 * tan_theta1)) / (tan_theta1 - tan_theta2)
    y = ((x2 - y2 * cot_theta2) - (x1 - y1 * cot_theta1)) / (cot_theta1 - cot_theta2)
    
    # å°†äº¤ç‚¹æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    intersections.append((x, y))

    # æ›´æ–°æ ‡ç­¾
    print(f"ç›®æ ‡ç‚¹åæ ‡ï¼š({x:.2f}, {y:.2f})")
    
    return x, y

try:
    while True:
        # è¯»å–ä¸²å£æ•°æ®
        data1 = ser1.readline().decode('utf-8').strip()
        data2 = ser2.readline().decode('utf-8').strip()

        # è§£æå¹¶ç­›é€‰æ•°æ®
        if data1.startswith("+UUDF:") and data2.startswith("+UUDF:"):
            parts1 = data1.split(',')
            parts2 = data2.split(',')
            if len(parts1) == 10 and len(parts2) == 10:
                # æå–ç¬¬ä¸‰ã€ç¬¬å››æ•°æ®æ®µ
                angle1 = int(parts1[2])
                angle2 = int(parts2[2])
                # æ‰“å°æ•°æ®
                print("Ser1:", angle1)
                print("Ser2:", angle2)
                angles.append((angle1, angle2))

                # å¯è§†åŒ–
                plt.clf()  # æ¸…é™¤ä¹‹å‰çš„ç»˜å›¾
                plt.axis([0, 400, 0, 400])  # è°ƒæ•´æ¨ªçºµåæ ‡èŒƒå›´
                plt.plot(station1[0], station1[1], 'ro', label='Station 1')
                plt.plot(station2[0], station2[1], 'bo', label='Station 2')
                x, y = update_position(angle1, angle2)
                
                # ç»˜åˆ¶æ‰€æœ‰äº¤ç‚¹
                for point in intersections[-80:]: #ç»˜åˆ¶è¿‘80ä¸ªç‚¹
                    plt.plot(point[0], point[1], 'go')
                    
                # åªç»˜åˆ¶å½“å‰ä½ç½®
                # plt.plot(x, y, 'go')
                    
                plt.pause(0.001)  # å»¶è¿Ÿä¸€æ®µæ—¶é—´ï¼Œä»¥å…è®¸å›¾å½¢æ›´æ–°

except serial.SerialException as e:
    print("æ‰“å¼€ä¸²å£å¤±è´¥ï¼š", e)

finally:
    # å…³é—­ä¸²å£
    ser1.close()
    ser2.close()
    print("ä¸²å£å·²å…³é—­")
```

